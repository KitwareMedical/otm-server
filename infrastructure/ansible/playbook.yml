---
- name: Install project
  hosts: all
  become: yes

  pre_tasks:
    - name: Install system Python
      ansible.builtin.apt:
        name:
          - python3.9
          - python3.9-dev
          - python3.9-venv
          - python3-pip
          - python3-setuptools
        update_cache: true
      become_user: root

    - name: Set python3.9 as python3
      ansible.builtin.command: update-alternatives --install /usr/local/bin/python3 python3 /usr/bin/python3.9 40
      become: true
      become_user: root

    - name: Install R
      ansible.builtin.shell: |
        apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
        add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/'
        apt install -y r-base
      become: true
      become_user: root

  roles:
    - role: girder.celery
      vars:
        celery_app: optimal_transport_morphometry.celery
        celery_repository_url: https://github.com/girder/otm-server
        celery_repository_ref: more-infrastructure
        celery_environment:
          DJANGO_CONFIGURATION: CeleryWorkerConfiguration
          # DB
          DJANGO_DATABASE_URL: "{{ lookup('env', 'DJANGO_DATABASE_URL') }}"
          # Celery
          DJANGO_CELERY_BROKER_URL: "{{ lookup('env', 'DJANGO_CELERY_BROKER_URL') }}"
          # Email
          DJANGO_EMAIL_URL: "{{ lookup('env', 'DJANGO_EMAIL_URL') }}"
          DJANGO_DEFAULT_FROM_EMAIL: "{{ lookup('env', 'DJANGO_DEFAULT_FROM_EMAIL') }}"
          # S3
          DJANGO_STORAGE_BUCKET_NAME: "{{ lookup('env', 'DJANGO_STORAGE_BUCKET_NAME') }}"
          AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
          AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
